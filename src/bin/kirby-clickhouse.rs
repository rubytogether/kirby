use std::io::stdout;

use argparse::{ArgumentParser, Collect, StoreTrue};

extern crate kirby;

struct Options {
    paths: Vec<String>,
    gzip: bool,
}

fn main() -> Result<(), std::io::Error> {
    let mut opts = Options {
        paths: ["test/sample_500.log".to_string()].to_vec(),
        gzip: false,
    };

    {
        let mut ap = ArgumentParser::new();
        ap.set_description("Parse a RubyGems.org Fastly JSON log file.");
        ap.refer(&mut opts.gzip)
            .add_option(&["--gzip"], StoreTrue, "Gzip output");
        ap.refer(&mut opts.paths).add_argument(
            "FILE",
            Collect,
            "Paths to the log file(s) to process",
        );
        ap.parse_args_or_exit();
    }

    let context = kirby::clickhouse::Context::new(&kirby::full_name_lengths::FULL_NAMES);

    for path in opts.paths {
        kirby::file_clickhouse(&mut stdout(), &path, &context)?
    }
    Ok(())
}
#[cfg(test)]
mod tests {
    use std::collections::HashMap;

    use super::*;

    #[test]
    fn test_sample_500_clickhouse() {
        let mut w: Vec<u8> = vec![];
        let full_names = HashMap::from([
            ("aws-sdk-codedeploy-1.3.0", (18, 5)),
            ("aws-sdk-dynamodbstreams-1.1.0", (23, 5)),
            ("aws-sdk-mediastoredata-1.1.0", (22, 5)),
            ("capybara-screenshot-1.0.14", (19, 6)),
            ("diff-lcs-1.3", (8, 3)),
            ("chef-sugar-3.1.1", (10, 5)),
            ("rspec-mocks-3.7.0", (11, 5)),
            ("rack-contrib-1.1.0", (12, 5)),
            ("rspec-expectations-3.8.1", (18, 5)),
            ("sidekiq-symbols-0.2.0", (15, 5)),
            ("aws-sdk-autoscalingplans-1.1.0", (24, 5)),
            ("rspec-expectations-3.7.0", (18, 5)),
            ("rack-protection-1.5.3", (15, 5)),
            ("aws-sdk-apigateway-1.9.0", (18, 5)),
            ("aws-sdk-servicecatalog-1.4.0", (22, 5)),
            ("capistrano-sidekiq-0.10.0", (18, 6)),
        ]);
        let context = kirby::clickhouse::Context::new(&full_names);
        kirby::file_clickhouse(&mut w, "test/sample_500.log", &context).unwrap();
        let output = String::from_utf8(w).unwrap();
        expect_test::expect![[r#"
        {"timestamp":"2018-07-09 19:00:00","request_path":"/gems/schmooze-0.1.6.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.7.6","rubygems":"2.7.6","ruby":"2.4.4","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":1,"client_continent":"NA","client_country":"United States","client_region":"CA","client_city":"mountain view","client_latitude":"37.389","client_longitude":"-122.075","client_timezone":"-700","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":258,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":10505,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1531162800.0,"cache_hits":1,"server_region":"US-East","server_datacenter":"IAD","gem":"schmooze","version":"0.1.6","platform":"ruby"}
        {"timestamp":"2018-04-28 07:00:03","request_path":"/gems/multi_xml-0.6.0.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.4.8","rubygems":"2.4.8","ruby":"2.1.8","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":1,"client_continent":"NA","client_country":"United States","client_region":"CA","client_city":"palo alto","client_latitude":"37.417","client_longitude":"-122.167","client_timezone":"-700","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":263,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":16178,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1524898800.0,"cache_hits":1,"server_region":"US-West","server_datacenter":"SJC","gem":"multi_xml","version":"0.6.0","platform":"ruby"}
        {"timestamp":"2018-07-21 07:00:03","request_path":"/gems/sucker_punch-2.0.4.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.7.6","rubygems":"2.7.6","ruby":"2.5.1","platform":{"cpu":"x86_64","os":"darwin","version":"17"}},"tls_cipher":"","time_elapsed":1,"client_continent":"EU","client_country":"Germany","client_region":"BE","client_city":"berlin","client_latitude":"52.383","client_longitude":"13.646","client_timezone":"200","client_connection":"cable","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":265,"http2":false,"tls":false,"tls_version":"","response_status":200,"response_text":"OK","response_bytes":17711,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1532156400.0,"cache_hits":1,"server_region":"EU-East","server_datacenter":"HHN","gem":"sucker_punch","version":"2.0.4","platform":"ruby"}
        {"timestamp":"2018-08-06 12:00:01","request_path":"/gems/deep_cloneable-2.3.2.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.6.12","rubygems":"2.6.12","ruby":"2.4.1","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":1,"client_continent":"NA","client_country":"United States","client_region":"CA","client_city":"mountain view","client_latitude":"37.389","client_longitude":"-122.075","client_timezone":"-700","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":265,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":19761,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1533556900.0,"cache_hits":1,"server_region":"US-Central","server_datacenter":"MDW","gem":"deep_cloneable","version":"2.3.2","platform":"ruby"}
        {"timestamp":"2018-03-15 13:00:02","request_path":"/gems/aws-sdk-codedeploy-1.3.0.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.6.14","rubygems":"2.6.14","ruby":"2.4.3","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":0,"client_continent":"EU","client_country":"United Kingdom","client_region":"LDS","client_city":"leeds","client_latitude":"53.842","client_longitude":"-1.536","client_timezone":"0","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":273,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":54065,"response_cache":"HIT, HIT","cache_state":"HIT","cache_lastuse":275.779,"cache_hits":93,"server_region":"EU-West","server_datacenter":"LCY","gem":"aws-sdk-codedeploy","version":"1.3.0","platform":"ruby"}
        {"timestamp":"2018-05-26 10:00:02","request_path":"/gems/uglifier-2.7.1.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.0.14.1","rubygems":"2.0.14.1","ruby":"2.0.0","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":1,"client_continent":"NA","client_country":"United States","client_region":"VA","client_city":"ashburn","client_latitude":"39.018","client_longitude":"-77.461","client_timezone":"-400","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":261,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":80134,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1527328800.0,"cache_hits":1,"server_region":"US-East","server_datacenter":"IAD","gem":"uglifier","version":"2.7.1","platform":"ruby"}
        {"timestamp":"2018-03-11 05:00:02","request_path":"/gems/signet-0.6.1.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.5.1","rubygems":"2.5.1","ruby":"2.3.1","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":1,"client_continent":"AS","client_country":"Japan","client_region":"13","client_city":"tokyo","client_latitude":"35.676","client_longitude":"139.770","client_timezone":"900","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":256,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":63749,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1520744400.0,"cache_hits":1,"server_region":"Asia","server_datacenter":"NRT","gem":"signet","version":"0.6.1","platform":"ruby"}
        {"timestamp":"2018-08-18 14:00:00","request_path":"/gems/aws-sdk-dynamodbstreams-1.1.0.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.6.14","rubygems":"2.6.14","ruby":"2.3.6","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":0,"client_continent":"NA","client_country":"United States","client_region":"GA","client_city":"decatur","client_latitude":"33.729","client_longitude":"-84.210","client_timezone":"-400","client_connection":"cable","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":274,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":17712,"response_cache":"HIT, HIT","cache_state":"HIT","cache_lastuse":760.256,"cache_hits":22,"server_region":"US-East","server_datacenter":"PDK","gem":"aws-sdk-dynamodbstreams","version":"1.1.0","platform":"ruby"}
        {"timestamp":"2018-05-02 15:00:02","request_path":"/gems/aws-sdk-mediastoredata-1.1.0.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.4.8","rubygems":"2.4.8","ruby":"2.1.6","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":0,"client_continent":"NA","client_country":"United States","client_region":"OR","client_city":"portland","client_latitude":"45.498","client_longitude":"-122.694","client_timezone":"-700","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":276,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":12485,"response_cache":"HIT","cache_state":"HIT","cache_lastuse":303.851,"cache_hits":259,"server_region":"US-West","server_datacenter":"SEA","gem":"aws-sdk-mediastoredata","version":"1.1.0","platform":"ruby"}
        {"timestamp":"2018-06-19 00:00:05","request_path":"/gems/pry-0.10.1.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.0.14.1","rubygems":"2.0.14.1","ruby":"2.0.0","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":1,"client_continent":"NA","client_country":"United States","client_region":"VA","client_city":"ashburn","client_latitude":"39.018","client_longitude":"-77.461","client_timezone":"-400","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":257,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":136455,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1529366400.0,"cache_hits":1,"server_region":"US-East","server_datacenter":"IAD","gem":"pry","version":"0.10.1","platform":"ruby"}
        {"timestamp":"2018-01-22 13:00:00","request_path":"/gems/capybara-screenshot-1.0.14.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.6.1","rubygems":"2.6.1","ruby":"2.2.5","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"","time_elapsed":1,"client_continent":"EU","client_country":"Ireland","client_region":"D","client_city":"dublin","client_latitude":"53.345","client_longitude":"-6.259","client_timezone":"0","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":270,"http2":false,"tls":null,"tls_version":"","response_status":200,"response_text":"OK","response_bytes":31621,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1516626000.0,"cache_hits":1,"server_region":"EU-West","server_datacenter":"LHR","gem":"capybara-screenshot","version":"1.0.14","platform":"ruby"}
        {"timestamp":"2018-06-15 10:00:01","request_path":"/gems/geocoder-1.4.7.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.7.7","rubygems":"2.7.7","ruby":"2.3.1","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":1,"client_continent":"EU","client_country":"Netherlands","client_region":"ZH","client_city":"leiden","client_latitude":"52.160","client_longitude":"4.478","client_timezone":"200","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":258,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":84271,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1529056800.0,"cache_hits":1,"server_region":"EU-Central","server_datacenter":"AMS","gem":"geocoder","version":"1.4.7","platform":"ruby"}
        {"timestamp":"2018-08-10 15:00:01","request_path":"/gems/rails-5.1.6.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.5.2.3","rubygems":"2.5.2.3","ruby":"2.3.7","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":1,"client_continent":"NA","client_country":"United States","client_region":"CA","client_city":"mountain view","client_latitude":"37.389","client_longitude":"-122.075","client_timezone":"-700","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":257,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":7472,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1533913200.0,"cache_hits":1,"server_region":"US-Central","server_datacenter":"MDW","gem":"rails","version":"5.1.6","platform":"ruby"}
        {"timestamp":"2018-08-22 19:22:03","request_path":"/gems/actionpack-4.2.9.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.5.2","rubygems":"2.5.2","ruby":"2.3.3","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":1,"client_continent":"NA","client_country":"Canada","client_region":"?","client_city":"?","client_latitude":"63.000","client_longitude":"-97.000","client_timezone":"9999","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":260,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":187696,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1534965800.0,"cache_hits":1,"server_region":"US-East","server_datacenter":"IAD","gem":"actionpack","version":"4.2.9","platform":"ruby"}
        {"timestamp":"2018-02-03 17:00:02","request_path":"/gems/diff-lcs-1.3.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.6.7","rubygems":"2.6.7","ruby":"2.3.1","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":0,"client_continent":"NA","client_country":"United States","client_region":"CA","client_city":"san jose","client_latitude":"37.217","client_longitude":"-121.856","client_timezone":"-800","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":260,"http2":false,"tls":null,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":46986,"response_cache":"HIT, HIT","cache_state":"HIT","cache_lastuse":321.719,"cache_hits":1558,"server_region":"US-West","server_datacenter":"SJC","gem":"diff-lcs","version":"1.3","platform":"ruby"}
        {"timestamp":"2018-02-15 17:00:03","request_path":"/gems/chef-sugar-3.1.1.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.6.13","rubygems":"2.6.13","ruby":"2.4.2","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":1,"client_continent":"NA","client_country":"United States","client_region":"OH","client_city":"columbus","client_latitude":"39.987","client_longitude":"-83.044","client_timezone":"-500","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":265,"http2":false,"tls":null,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":34654,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1518714000.0,"cache_hits":1,"server_region":"US-East","server_datacenter":"DCA","gem":"chef-sugar","version":"3.1.1","platform":"ruby"}
        {"timestamp":"2018-05-10 14:00:02","request_path":"/gems/rdoc-4.2.2.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.5.2","rubygems":"2.5.2","ruby":"2.3.3","platform":{"cpu":"x64","os":"mingw32","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":3,"client_continent":"NA","client_country":"United States","client_region":"CA","client_city":"san francisco","client_latitude":"37.786","client_longitude":"-122.436","client_timezone":"-700","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":681,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":739737,"response_cache":"HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1525960800.0,"cache_hits":1,"server_region":"US-West","server_datacenter":"SEA","gem":"rdoc","version":"4.2.2","platform":"ruby"}
        {"timestamp":"2018-05-10 14:00:02","request_path":"/gems/pdfkit-0.8.2.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.6.11","rubygems":"2.6.11","ruby":"2.3.3","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":1,"client_continent":"NA","client_country":"United States","client_region":"VA","client_city":"ashburn","client_latitude":"39.018","client_longitude":"-77.461","client_timezone":"-400","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":257,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":21765,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1525960800.0,"cache_hits":1,"server_region":"US-East","server_datacenter":"IAD","gem":"pdfkit","version":"0.8.2","platform":"ruby"}
        {"timestamp":"2018-02-07 10:00:01","request_path":"/gems/rspec-mocks-3.7.0.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.6.7","rubygems":"2.6.7","ruby":"2.3.1","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":0,"client_continent":"EU","client_country":"Ireland","client_region":"D","client_city":"dublin","client_latitude":"53.345","client_longitude":"-6.259","client_timezone":"0","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":265,"http2":false,"tls":null,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":78731,"response_cache":"HIT, HIT","cache_state":"HIT","cache_lastuse":49.131,"cache_hits":162,"server_region":"EU-West","server_datacenter":"LHR","gem":"rspec-mocks","version":"3.7.0","platform":"ruby"}
        {"timestamp":"2018-07-05 19:00:01","request_path":"/gems/rack-contrib-1.1.0.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.6.14","rubygems":"2.6.14","ruby":"2.2.3","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":81,"client_continent":"NA","client_country":"United States","client_region":"VA","client_city":"ashburn","client_latitude":"39.018","client_longitude":"-77.461","client_timezone":"-400","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":267,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":39686,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1530817200.0,"cache_hits":1,"server_region":"US-East","server_datacenter":"DCA","gem":"rack-contrib","version":"1.1.0","platform":"ruby"}
        {"timestamp":"2018-07-05 19:00:01","request_path":"/gems/rack-contrib-1.1.0.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.6.14","rubygems":"2.6.14","ruby":"2.2.3","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":81,"client_continent":"NA","client_country":"United States","client_region":"VA","client_city":"ashburn","client_latitude":"39.018","client_longitude":"-77.461","client_timezone":"-400","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":267,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":39686,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1530817200.0,"cache_hits":1,"server_region":"US-East","server_datacenter":"DCA","gem":"rack-contrib","version":"1.1.0","platform":"ruby"}
        {"timestamp":"2018-08-14 15:00:00","request_path":"/gems/rspec-expectations-3.8.1.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.7.3","rubygems":"2.7.3","ruby":"2.5.0","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":0,"client_continent":"NA","client_country":"Canada","client_region":"ON","client_city":"brampton","client_latitude":"43.788","client_longitude":"-79.737","client_timezone":"-400","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":266,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":82736,"response_cache":"HIT, HIT","cache_state":"HIT","cache_lastuse":134.388,"cache_hits":5658,"server_region":"US-East","server_datacenter":"JFK","gem":"rspec-expectations","version":"3.8.1","platform":"ruby"}
        {"timestamp":"2018-02-19 16:00:01","request_path":"/gems/sidekiq-symbols-0.2.0.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.5.1","rubygems":"2.5.1","ruby":"2.3.1","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":1,"client_continent":"NA","client_country":"United States","client_region":"VA","client_city":"ashburn","client_latitude":"39.018","client_longitude":"-77.461","client_timezone":"-500","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":265,"http2":false,"tls":null,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":11654,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1519056000.0,"cache_hits":1,"server_region":"US-East","server_datacenter":"IAD","gem":"sidekiq-symbols","version":"0.2.0","platform":"ruby"}
        {"timestamp":"2018-05-14 11:00:01","request_path":"/gems/fission-0.5.0.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.5.2.1","rubygems":"2.5.2.1","ruby":"2.3.1","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":1,"client_continent":"NA","client_country":"United States","client_region":"CA","client_city":"los angeles","client_latitude":"34.063","client_longitude":"-118.239","client_timezone":"-700","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":259,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":46342,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1526295600.0,"cache_hits":1,"server_region":"US-West","server_datacenter":"BUR","gem":"fission","version":"0.5.0","platform":"ruby"}
        {"timestamp":"2018-03-19 17:00:00","request_path":"/gems/aws-sdk-autoscalingplans-1.1.0.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.4.5","rubygems":"2.4.5","ruby":"2.2.2","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"","time_elapsed":0,"client_continent":"NA","client_country":"United States","client_region":"OR","client_city":"portland","client_latitude":"45.498","client_longitude":"-122.694","client_timezone":"-700","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":273,"http2":false,"tls":false,"tls_version":"","response_status":200,"response_text":"OK","response_bytes":16070,"response_cache":"HIT","cache_state":"HIT","cache_lastuse":91.163,"cache_hits":1596,"server_region":"US-West","server_datacenter":"SEA","gem":"aws-sdk-autoscalingplans","version":"1.1.0","platform":"ruby"}
        {"timestamp":"2018-03-23 05:00:00","request_path":"/gems/rspec-mocks-3.7.0.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.6.7","rubygems":"2.6.7","ruby":"2.3.1","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":0,"client_continent":"NA","client_country":"United States","client_region":"VA","client_city":"ashburn","client_latitude":"39.018","client_longitude":"-77.461","client_timezone":"-400","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":265,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":78645,"response_cache":"MISS, HIT","cache_state":"HIT","cache_lastuse":9.586,"cache_hits":10980,"server_region":"US-East","server_datacenter":"DCA","gem":"rspec-mocks","version":"3.7.0","platform":"ruby"}
        {"timestamp":"2018-04-28 07:00:03","request_path":"/gems/public_suffix-3.0.1.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.7.3","rubygems":"2.7.3","ruby":"2.5.0","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":1,"client_continent":"NA","client_country":"United States","client_region":"VA","client_city":"ashburn","client_latitude":"39.018","client_longitude":"-77.461","client_timezone":"-400","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":261,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":96048,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1524898800.0,"cache_hits":1,"server_region":"US-East","server_datacenter":"DCA","gem":"public_suffix","version":"3.0.1","platform":"ruby"}
        {"timestamp":"2018-05-26 10:00:01","request_path":"/gems/rspec-expectations-3.7.0.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.6.7","rubygems":"2.6.7","ruby":"2.3.1","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":0,"client_continent":"AS","client_country":"Japan","client_region":"13","client_city":"tokyo","client_latitude":"35.676","client_longitude":"139.770","client_timezone":"900","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":272,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":81715,"response_cache":"HIT, HIT","cache_state":"HIT","cache_lastuse":10.823,"cache_hits":34785,"server_region":"Asia","server_datacenter":"NRT","gem":"rspec-expectations","version":"3.7.0","platform":"ruby"}
        {"timestamp":"2018-03-15 13:00:01","request_path":"/gems/open4-1.3.4.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.7.6","rubygems":"2.7.6","ruby":"2.3.6","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":0,"client_continent":"EU","client_country":"Poland","client_region":"MA","client_city":"zabierz√≥w","client_latitude":"50.114","client_longitude":"19.799","client_timezone":"100","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":255,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":19720,"response_cache":"HIT, HIT","cache_state":"HIT","cache_lastuse":65.807,"cache_hits":125,"server_region":"EU-East","server_datacenter":"FRA","gem":"open4","version":"1.3.4","platform":"ruby"}
        {"timestamp":"2018-03-15 13:00:00","request_path":"/gems/rack-protection-1.5.3.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.5.1","rubygems":"2.5.1","ruby":"2.3.0","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":0,"client_continent":"EU","client_country":"Germany","client_region":"HE","client_city":"frankfurt am main","client_latitude":"50.167","client_longitude":"8.679","client_timezone":"100","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":263,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":19207,"response_cache":"HIT, HIT","cache_state":"HIT","cache_lastuse":619.538,"cache_hits":3,"server_region":"EU-East","server_datacenter":"HHN","gem":"rack-protection","version":"1.5.3","platform":"ruby"}
        {"timestamp":"2018-07-17 15:00:00","request_path":"/gems/redis-3.2.1.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.6.14","rubygems":"2.6.14","ruby":"2.1.2","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":0,"client_continent":"AS","client_country":"Singapore","client_region":"01","client_city":"singapore","client_latitude":"1.300","client_longitude":"103.849","client_timezone":"800","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":771,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":74659,"response_cache":"HIT","cache_state":"HIT","cache_lastuse":572.615,"cache_hits":2,"server_region":"US-West","server_datacenter":"SEA","gem":"redis","version":"3.2.1","platform":"ruby"}
        {"timestamp":"2018-03-07 02:00:02","request_path":"/gems/fuzzyurl-0.9.0.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.6.13","rubygems":"2.6.13","ruby":"2.4.2","platform":{"cpu":"x86_64","os":"darwin","version":"16"}},"tls_cipher":"","time_elapsed":49,"client_continent":"NA","client_country":"United States","client_region":"IL","client_city":"rolling meadows","client_latitude":"42.078","client_longitude":"-88.029","client_timezone":"-600","client_connection":"cable","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":263,"http2":false,"tls":false,"tls_version":"","response_status":200,"response_text":"OK","response_bytes":9481,"response_cache":"HIT, MISS","cache_state":"MISS-CLUSTER","cache_lastuse":1520388000.0,"cache_hits":0,"server_region":"US-Central","server_datacenter":"MDW","gem":"fuzzyurl","version":"0.9.0","platform":"ruby"}
        {"timestamp":"2018-02-07 10:00:01","request_path":"/gems/aws-sdk-apigateway-1.9.0.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.6.8","rubygems":"2.6.8","ruby":"2.3.1","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":0,"client_continent":"NA","client_country":"United States","client_region":"VA","client_city":"ashburn","client_latitude":"39.018","client_longitude":"-77.461","client_timezone":"-500","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":272,"http2":false,"tls":null,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":98181,"response_cache":"HIT, HIT","cache_state":"HIT","cache_lastuse":1251.097,"cache_hits":13,"server_region":"US-East","server_datacenter":"DCA","gem":"aws-sdk-apigateway","version":"1.9.0","platform":"ruby"}
        {"timestamp":"2018-05-30 05:00:01","request_path":"/gems/tzinfo-1.2.5.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.7.7","rubygems":"2.7.7","ruby":"2.3.7","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":0,"client_continent":"NA","client_country":"United States","client_region":"VA","client_city":"ashburn","client_latitude":"39.018","client_longitude":"-77.461","client_timezone":"-400","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":256,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":154418,"response_cache":"HIT, HIT","cache_state":"HIT","cache_lastuse":482.836,"cache_hits":437,"server_region":"US-East","server_datacenter":"IAD","gem":"tzinfo","version":"1.2.5","platform":"ruby"}
        {"timestamp":"2018-01-22 13:00:02","request_path":"/gems/multi_json-1.12.1.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.5.2","rubygems":"2.5.2","ruby":"2.3.3","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":0,"client_continent":"AS","client_country":"Japan","client_region":"13","client_city":"tokyo","client_latitude":"35.676","client_longitude":"139.770","client_timezone":"900","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":261,"http2":false,"tls":null,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":26979,"response_cache":"HIT, HIT","cache_state":"HIT","cache_lastuse":31.032,"cache_hits":19,"server_region":"Asia","server_datacenter":"ITM","gem":"multi_json","version":"1.12.1","platform":"ruby"}
        {"timestamp":"2018-03-23 05:00:01","request_path":"/gems/aws-sdk-servicecatalog-1.4.0.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.6.8","rubygems":"2.6.8","ruby":"2.3.1","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":0,"client_continent":"NA","client_country":"United States","client_region":"OR","client_city":"portland","client_latitude":"45.498","client_longitude":"-122.694","client_timezone":"-700","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":276,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":46789,"response_cache":"HIT","cache_state":"HIT","cache_lastuse":169.625,"cache_hits":22,"server_region":"US-West","server_datacenter":"SEA","gem":"aws-sdk-servicecatalog","version":"1.4.0","platform":"ruby"}
        {"timestamp":"2018-06-07 12:00:00","request_path":"/gems/rspec_api_documentation-4.8.0.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.6.8","rubygems":"2.6.8","ruby":"2.2.4","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":32,"client_continent":"NA","client_country":"United States","client_region":"CA","client_city":"san rafael","client_latitude":"37.975","client_longitude":"-122.510","client_timezone":"-700","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":273,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":20743,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1528372900.0,"cache_hits":1,"server_region":"US-West","server_datacenter":"SJC","gem":"rspec_api_documentation","version":"4.8.0","platform":"ruby"}
        {"timestamp":"2018-08-14 15:00:02","request_path":"/gems/rails_admin-1.2.0.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.7.6","rubygems":"2.7.6","ruby":"2.4.3","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":32,"client_continent":"NA","client_country":"United States","client_region":"CA","client_city":"mountain view","client_latitude":"37.389","client_longitude":"-122.075","client_timezone":"-700","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":261,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":348465,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1534258800.0,"cache_hits":1,"server_region":"US-East","server_datacenter":"DCA","gem":"rails_admin","version":"1.2.0","platform":"ruby"}
        {"timestamp":"2018-03-15 13:00:00","request_path":"/gems/capistrano-sidekiq-0.10.0.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.5.1","rubygems":"2.5.1","ruby":"2.3.0","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":1,"client_continent":"EU","client_country":"Germany","client_region":"HE","client_city":"frankfurt am main","client_latitude":"50.167","client_longitude":"8.679","client_timezone":"100","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":267,"http2":false,"tls":true,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":12079,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1521118800.0,"cache_hits":1,"server_region":"EU-East","server_datacenter":"FRA","gem":"capistrano-sidekiq","version":"0.10.0","platform":"ruby"}
        {"timestamp":"2018-01-14 00:00:03","request_path":"/gems/tabularize-0.2.10.gem","request_query":"","user_agent":{"agent_name":"rubygems","agent_version":"2.5.1","rubygems":"2.5.1","ruby":"2.3.1","platform":{"cpu":"x86_64","os":"linux","version":null}},"tls_cipher":"ECDHE-RSA-AES128-GCM-SHA256","time_elapsed":1,"client_continent":"NA","client_country":"United States","client_region":"VA","client_city":"ashburn","client_latitude":"39.018","client_longitude":"-77.461","client_timezone":"-500","client_connection":"broadband","request":"GET","request_host":"oregon.production.s3.rubygems.org.s3-us-west-2.amazonaws.com","request_bytes":265,"http2":false,"tls":null,"tls_version":"TLSv1.2","response_status":200,"response_text":"OK","response_bytes":15238,"response_cache":"HIT, HIT","cache_state":"HIT-CLUSTER","cache_lastuse":1515888000.0,"cache_hits":1,"server_region":"US-East","server_datacenter":"IAD","gem":"tabularize","version":"0.2.10","platform":"ruby"}
    "#]]
    .assert_eq(&output);
    }
}
